---
title: 游戏引擎多线程架构研究
date: 2019-11-18 21:20:38
tags: [GameEngine, Architecture]
---
传统游戏开发过程中使用的多是单线程游戏循环，使得游戏在元素较多时面临性能问题。而由于摩尔定律，芯片在单核心频率上的提升愈发困难，转而向多核心发现发展。因此解决游戏性能问题唯有做好多线程设计，提高CPU多核性能运用。最近在开发体素沙盒游戏引擎的过程中，对游戏引擎的多线程架构做了很多思考和设计，最终还是深觉实体组件系统（Entity-Component-System）架构最适合游戏引擎的高性能应用。接下来对现有或个人提出的多线程架构做了略微的讲解和分析。

## 传统多线程架构
通过在进行互斥操作时对操作的数据进行加锁，实现对数据唯一性的保证，从而实现多线程架构。

**缺点：** 反复加锁性能较低容易死锁，代码不易维护和扩展。

## 分布式架构
将游戏世界划分为多个区域，区域中的更新仍采用传统单线程方式进行更新，区域之间则通过使用类似于分布式架构的事件总线互相通知。

**缺点：** 当更新集中在一个区域内时，区域内性能问题仍不能有效解决。

## 不相邻更新架构
分布式架构的升级版，缩小区域的大小，将区域划分为更小的部分，同时在更新时临近区域并不会更新，保持上锁状态以便操作。

**缺点：** 对于区域更新的任务调度问题难以解决，代码不易维护。

## 四叉树均衡架构
不相邻更新架构的升级版，受实体查找四叉树的启发，将需要更新的区域用四叉树进行划分，更新频率越高的区域所在的节点越深，将每个区域的任务量都划分得尽量平均。

**缺点：** 一时兴起想起来但没能完善就毙掉的方案，难以实现。

## 逻辑解耦架构
将对象的逻辑脱离对象本身，优先更新重要的任务以确保游戏的正常运行，同时降低对游戏不重要的任务执行的频率。该架构实现了对逻辑的有效解耦，提高了代码的可读性和可维护性，该架构更容易解决多线程的任务调度问题。

**缺点：** 对数据仍未解耦，难以解决操作互质和线程死锁的问题。

## 实体组件系统（Entity-Component-System）架构
在逻辑解耦架构的基础上进一步对数据进行解耦，将数据从对象之中解放出来成为一个个组件，逻辑也从对象之中解放出来成为一个个系统，而对于对象数据的引用则统一由实体进行管理。

系统对更新实体所需的组件进行声明，使得对逻辑系统进行调用分析成为可能，进一步提高了架构的智能性，对于逻辑系统的调度问题也更容易解决。

对数据的解放，将数据分别包装为组件则使对CPU缓存友好成为了可能，数据可以连续分配在内存中，逻辑系统也连续地更新实体，使得每下一次更新所需的数据都位于上一次更新的数据的相邻内存。组件也使数据无需上锁，只需保证逻辑系统之间没有要求对相同的数据进行读取和操作即可。

**缺点：** 对数据和逻辑过于解耦，开发者常常在职责划分问题上左右为难。

综上所述，所有的架构中我个人认为最好的架构仍是ECS架构。该博文仅为记录我个人的思考和进步过程，其中观点仍有幼稚之处还望见谅，如有不妥之处欢迎在本文发言讨论。